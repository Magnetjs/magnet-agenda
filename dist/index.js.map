{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import 'source-map-support/register';\n\nimport co from 'co';\nimport requireAll from 'require-all';\nimport fs from 'mz/fs';\nimport Agenda from 'agenda';\n\nexport default class Scheduler {\n  constructor(app) {\n    this.app = app;\n    this.schedulers = {};\n  }\n\n  *setup() {\n    let config = this.app.config.agenda;\n    config.db.address = `${config.db.host}:${config.db.port}/${config.db.database}`;\n\n    if (config.db.username || config.db.password) {\n      config.db.address = `${config.db.username}:${config.db.password}@${address}`;\n    }\n\n    let agenda = new Agenda(config);\n\n    let exists = yield fs.exists(this.app.config.paths.server.scheduler);\n    let schedulers = requireAll(this.app.config.paths.server.scheduler);\n\n    // TODO: Remove\n    agenda.purge(function(err, numRemoved) {\n    });\n\n    agenda.on('fail', (err) => {\n      this.app.log.error(err);\n    });\n\n    // Prepare scheduler\n    for (let key in schedulers) {\n      if (schedulers.hasOwnProperty(key)) {\n        let scheduler = schedulers[key];\n        let name = scheduler.name || key;\n\n        agenda.define(name, scheduler.options || {}, (data, done) => {\n          co(function *() {\n            yield scheduler.process.call(this, data);\n          }.bind(this))\n          .then(function (result) {\n            done(null, result);\n          }, (err) => {\n            this.app.log.error(err);\n            done(err);\n          })\n          .catch((err) => {\n            this.app.log.error(err);\n            done(err);\n          });\n        });\n\n        if (scheduler.every) {\n          agenda.every(scheduler.every, name);\n        } else if (scheduler.schedule) {\n          agenda.schedule(scheduler.schedule, name);\n        }\n      }\n    }\n\n    agenda.start();\n  }\n}\n"],"sourceRoot":"/source/"}